<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINIGAME íšŒì›ê°€ì…</title>
<style>
        @font-face {
            font-family: 'PixelFont'; 
            src: url('../DungGeunMo.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url('../bgimg/í•˜ëŠ˜ë°°ê²½.png'); 
            background-size: cover;
            background-position: center;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-repeat: no-repeat;
            background-size: 60% auto;
            background-color: #87CEEB;
        }

        .container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'PixelFont', monospace;
        }

        .register-window {
            width: 600px;
            height: 560px; 
            background-color: rgba(0, 0, 0, 0.8);
            border: 4px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            color: #3a3a3a;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            padding: 20px;
            box-sizing: border-box;
        }

        .title-bar {
            background-color: #3a3a3a;
            color: white;
            font-size: 24px;
            padding: 10px 0;
            text-align: center;
            margin-bottom: 5px;
            border-bottom: 2px solid #5a5a5a;
            text-shadow: 2px 2px 0 #000;
        }

        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 30px; 
        }

        .input-field-container {
            display: flex;
            align-items: center;
            margin: 15px 0; 
            width: 80%;
            justify-content: space-between; 
            max-width: 500px;
        }

        .input-label {
            font-size: 16px;
            color: white;
            width: 120px; 
            flex-shrink: 0;
            text-align: left; 
        }

        .check-group {
            display: flex;
            align-items: center;
            width: calc(100% - 90px); 
        }
        
        .input-field-container:not(:has(.check-group)) .input-field {
            width: calc(100% - 140px); 
        }

        .input-field {
            flex-grow: 1; 
            height: 40px;
            padding: 0 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: #fff;
            box-sizing: border-box; 
        }

        .check-group .input-field {
            margin-right: 10px;
        }

        .check-button {
     	    width: 80px;
            height: 40px; 
            background-color: #28a745;
            color: white;
            font-size: 14px;
            padding: 0;
            cursor: pointer;
            flex-shrink: 0; 
            text-shadow: 2px 2px 0 #218838;

            box-shadow: 
                -4px -4px 0 #7dd891 inset, 
                 4px  4px 0 #218838 inset;
            font-family: 'PixelFont', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .check-button:hover {
            background-color: #218838;
        }

        .next-button {
            width: 150px; 
            height: 50px; 
            margin: 20px 0 15px;
            background-color: #d89617;
            color: white;
            font-size: 24px; 
            border: 4px solid #8b4513;
            cursor: pointer;
            text-shadow: 2px 2px 0 #8b4513;
            box-shadow: 
                -4px -4px 0 #ffe082 inset, 
                 4px  4px 0 #8b4513 inset;
            line-height: 42px; 
            padding: 0;
            box-sizing: border-box;
            font-family: 'PixelFont', monospace; 
        }

        .next-button:hover {
            background-color: #e0ac42;
        }

        /* â­ï¸ í†µí•© ë©”ì‹œì§€ ì˜ì—­ ìŠ¤íƒ€ì¼ (ìˆ˜ì •ë¨: min-height, opacity) â­ï¸ */
        #responseMessage {
            opacity: 0; /* ìˆ¨ê¹€ (ê³µê°„ ìœ ì§€) */
            height: auto; 
            min-height: 40px; /* ìµœì†Œ ë†’ì´ í™•ë³´ë¡œ ë²„íŠ¼ ë°€ë¦¼ ë°©ì§€ */
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 20px; 
            width: 80%;
            max-width: 500px;
            border-radius: 4px;
            text-align: center;
            font-family: 'PixelFont', monospace;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            transition: opacity 0.3s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ ì¶”ê°€ */
        }

        /* ìƒíƒœë³„ ë°°ê²½ìƒ‰ í´ë˜ìŠ¤ (ìˆ˜ì •ë¨: opacity ì‚¬ìš©) */
        .bg-info { background-color: #17a2b8; opacity: 1; }
        .bg-pending { background-color: #ffc107; color: black; opacity: 1; } 
        .bg-success { background-color: #28a745; opacity: 1; } 
        .bg-error { background-color: #dc3545; opacity: 1; } 

        /* global-status-msgì„ responseMessageë¡œ í†µí•©í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤. */
        #global-status-msg {
            display: none; 
        }

    </style>

    <script>
    // â­ï¸ ì „ì—­ ì¸ì¦ ìƒíƒœ í”Œë˜ê·¸ â­ï¸
    let isIdChecked = false;
    let isNicknameChecked = false;
    
    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (ìˆ˜ì •ë¨: opacity ì‚¬ìš©)
    function showMessage(element, text, className) {
        element.textContent = text;
        element.className = className; 
        element.style.opacity = 1; // ë³´ì´ê²Œ í•¨
    }
    
    // ID ë˜ëŠ” ë‹‰ë„¤ì„ ì…ë ¥ì´ ë³€ê²½ë˜ë©´ í”Œë˜ê·¸ ì´ˆê¸°í™” ë° ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° (ìˆ˜ì •ë¨: opacity ì‚¬ìš©)
    function resetCheckStatus(type) {
        const responseMessageArea = document.getElementById('responseMessage');
        if (type === 'id') {
            isIdChecked = false;
        } else if (type === 'nickname') {
            isNicknameChecked = false;
        }
        
        responseMessageArea.style.opacity = 0; // ìˆ¨ê¹€
        responseMessageArea.textContent = '';
        responseMessageArea.className = '';
    }

    document.addEventListener("DOMContentLoaded", function() {
        const nextButton = document.querySelector('.next-button');
        const responseMessageArea = document.getElementById('responseMessage'); // í†µí•© ë©”ì‹œì§€ ì˜ì—­
        
        // ì…ë ¥ í•„ë“œ ì •ì˜
        const userIdInput = document.getElementById('user-id');
        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('password-confirm');
        const nicknameInput = document.getElementById('nickname');
        
        userIdInput.addEventListener('input', () => resetCheckStatus('id'));
        nicknameInput.addEventListener('input', () => resetCheckStatus('nickname'));

        // 1. ì¤‘ë³µí™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ AJAX ìš”ì²­
        document.getElementById('check-id-btn').addEventListener('click', () => checkDuplicate('id', userIdInput.value));
        document.getElementById('check-nickname-btn').addEventListener('click', () => checkDuplicate('nickname', nicknameInput.value));

        function checkDuplicate(type, value) {
            if (!value.trim()) {
                showMessage(responseMessageArea, `${type === 'id' ? 'ID' : 'ë‹‰ë„¤ì„'}ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`, 'bg-error');
                return;
            }
            
            showMessage(responseMessageArea, `ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...`, 'bg-pending');

            // âš ï¸ Context Path í™•ì¸ í•„ìˆ˜! âš ï¸
            fetch('/team_project/checkDuplicate', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `type=${type}&value=${encodeURIComponent(value)}`
            })
            .then(response => response.text())
            .then(text => {
                const fieldName = type === 'id' ? 'ID' : 'ë‹‰ë„¤ì„';

                if (text === "available") {
                    showMessage(responseMessageArea, `ì‚¬ìš© ê°€ëŠ¥í•œ ${fieldName}ì…ë‹ˆë‹¤!`, 'bg-success');
                    if (type === 'id') isIdChecked = true;
                    else if (type === 'nickname') isNicknameChecked = true;
                    
                } else if (text === "duplicate") {
                    showMessage(responseMessageArea, `ì´ë¯¸ ìˆëŠ” ${fieldName}ì…ë‹ˆë‹¤.`, 'bg-error');
                    if (type === 'id') isIdChecked = false;
                    else if (type === 'nickname') isNicknameChecked = false;

                } else {
                    showMessage(responseMessageArea, `ì„œë²„ ì˜¤ë¥˜: ${text}`, 'bg-error');
                    if (type === 'id') isIdChecked = false;
                    else if (type === 'nickname') isIdChecked = false;
                }
            })
            .catch(error => {
                console.error('Duplicate Check error:', error);
                showMessage(responseMessageArea, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bg-error');
                if (type === 'id') isIdChecked = false;
                else if (type === 'nickname') isIdChecked = false;
            });
        }
        
        // 2. NEXT (ê°€ì…ì™„ë£Œ) ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘ (JSON ì‘ë‹µ ì²˜ë¦¬ ì•ˆì •í™” ë¡œì§)
        nextButton.addEventListener('click', function() {
            const userId = userIdInput.value; 
            const password = passwordInput.value;
            const passwordConfirm = passwordConfirmInput.value;
            const nickname = nicknameInput.value; 

            if (!userId || !password || !passwordConfirm || !nickname) {
                showMessage(responseMessageArea, "ëª¨ë“  í•„ë“œë¥¼ ë¹ ì§ì—†ì´ ì…ë ¥í•˜ì„¸ìš”.", 'bg-error');
                return;
            }
            if (password !== passwordConfirm) {
                showMessage(responseMessageArea, "ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", 'bg-error');
                return;
            }
            if (!isIdChecked) {
                showMessage(responseMessageArea, "ğŸš¨ ID ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•˜ê³  ì‚¬ìš© ê°€ëŠ¥ ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤.", 'bg-error');
                return;
            }
            if (!isNicknameChecked) {
                showMessage(responseMessageArea, "ğŸš¨ ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•˜ê³  ì‚¬ìš© ê°€ëŠ¥ ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤.", 'bg-error');
                return;
            }
            
            showMessage(responseMessageArea, "íšŒì›ê°€ì… ìš”ì²­ ì¤‘...", 'bg-pending');

            const formData = new URLSearchParams();
            formData.append('user-id', userId);
            formData.append('password', password);
            formData.append('nickname', nickname);
            
            // ìµœì¢… ê°€ì… ë¡œì§: RegisterUserServlet í˜¸ì¶œ
            fetch('/team_project/registerUser', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            })
            // â­ï¸ JSON íŒŒì‹± ì•ˆì •í™” ë¡œì§ ì ìš© â­ï¸
            .then(response => {
                return response.text().then(text => {
                    try {
                        // í…ìŠ¤íŠ¸ë¥¼ JSONìœ¼ë¡œ íŒŒì‹± ì‹œë„
                        return JSON.parse(text);
                    } catch (e) {
                        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í¬í•¨í•˜ì—¬ ì—ëŸ¬ ë°œìƒ
                        if (!response.ok) {
                            throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${text.substring(0, 50)}...`);
                        }
                        throw new Error("ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜: 200 OKì´ì§€ë§Œ JSON íŒŒì‹± ì‹¤íŒ¨.");
                    }
                });
            })
            .then(data => {
                if (data.status === 'success') {
                    showMessage(responseMessageArea, data.message + ' ì ì‹œ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'bg-success');
                    setTimeout(() => {

                    	window.location.href = "../main/main_page.html"; 
                        
                    }, 1000); 

                } else {
                    // ì„œë²„ ì¸¡ì—ì„œ ë³´ë‚¸ ì˜¤ë¥˜ ë©”ì‹œì§€ (data.status === 'error')
                    const errorMessage = data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    showMessage(responseMessageArea, `íšŒì›ê°€ì… ì‹¤íŒ¨: ${errorMessage}`, 'bg-error');
                    console.error("Server Error Detail:", errorMessage);
                }
            })
            .catch(error => {
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, JSON íŒŒì‹± ì˜¤ë¥˜ ë“± ëª¨ë“  ì˜ˆì™¸ ì²˜ë¦¬
                console.error('Registration Fetch error:', error);
                showMessage(responseMessageArea, `ì¹˜ëª…ì ì¸ í†µì‹  ì˜¤ë¥˜: ${error.message}`, 'bg-error');
            });
        });
    });
</script>
</head>

<body>

    <div class="container">
        <div class="register-window">
            <div class="title-bar">íšŒì›ê°€ì…</div>

            <div class="content-area">
                <div class="input-field-container">
                    <label class="input-label" for="user-id">ID</label>
                    <div class="check-group">
                        <input class="input-field" type="text" id="user-id" placeholder="IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                        <button class="check-button" id="check-id-btn">ì¤‘ë³µí™•ì¸</button>
                    </div>
                </div>
                <div class="input-field-container">
                    <label class="input-label" for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input class="input-field" type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                
                <div class="input-field-container">
                    <label class="input-label" for="password-confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input class="input-field" type="password" id="password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                
                <div class="input-field-container">
                    <label class="input-label" for="nickname">ë‹‰ë„¤ì„</label>
                    <div class="check-group">
                        <input class="input-field" type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        <button class="check-button" id="check-nickname-btn">ì¤‘ë³µí™•ì¸</button>
                    </div>
                </div>
                <div id="responseMessage"></div>
                
                <button class="next-button">ê°€ì…ì™„ë£Œ</button>

                <div id="global-status-msg" class="msg-status"></div>
            </div>
        </div>
    </div>

</body>
</html>