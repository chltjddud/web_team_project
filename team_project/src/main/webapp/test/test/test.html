<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINIGAME íšŒì›ê°€ì…</title>
<style>
        /* í°íŠ¸ ë“±ë¡ */
        @font-face {
            font-family: 'PixelFont'; 
            src: url('../DungGeunMo.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }

        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë°°ê²½ */
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url('../bgimg/í•˜ëŠ˜ë°°ê²½.png'); 
            background-size: cover;
            background-position: center;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-repeat: no-repeat;
            background-size: 60% auto;
            background-color: #87CEEB;
        }

        .container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'PixelFont', monospace;
        }

        /* íšŒì›ê°€ì… ì°½ */
        .register-window {
            width: 600px;
            height: 560px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 4px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            color: #3a3a3a;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            padding: 20px;
            box-sizing: border-box;
        }

        /* íƒ€ì´í‹€ ë°” */
        .title-bar {
            background-color: #3a3a3a;
            color: white;
            font-size: 24px;
            padding: 10px 0;
            text-align: center;
            margin-bottom: 5px;
            border-bottom: 2px solid #5a5a5a;
            text-shadow: 2px 2px 0 #000;
        }

        /* ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 30px; 
        }

        /* ë¼ë²¨ê³¼ ì…ë ¥ í•„ë“œë¥¼ ë¬¶ëŠ” ì»¨í…Œì´ë„ˆ (ì´ë¦„, ìƒë…„ì›”ì¼) */
        .input-field-container {
            display: flex;
            align-items: center;
            margin: 15px 0; 
            width: 80%;
            justify-content: space-between;
            max-width: 500px;
        }

        /* í¼ íƒœê·¸ê°€ .input-field-containerì˜ ì—­í• ì„ í•˜ë„ë¡ ìˆ˜ì • */
        /* ì´ë©”ì¼ ì „ì†¡ í¼ê³¼ ì¸ì¦ í™•ì¸ í¼ì— ì§ì ‘ ì ìš©í•˜ì—¬ í•œ ì¤„ ì •ë ¬ */
        #sendCodeForm, #verifyCodeForm {
            display: flex;
            align-items: center;
            margin: 15px 0; 
            width: 80%; 
            max-width: 500px;
            gap: 0px;
            justify-content: space-between;
        }
        
        .input-label {
            font-size: 16px;
            color: white;
            width: 120px;
            flex-shrink: 0;
            text-align: left; 
        }

        /* ì¼ë°˜ ì…ë ¥ í•„ë“œ(ì´ë¦„, ìƒë…„ì›”ì¼)ì˜ ë„ˆë¹„: ë¼ë²¨(120px) ì œì™¸ ë‚˜ë¨¸ì§€ ê³µê°„ */
        .input-field-container:not(:has(.email-input-group)):not(:has(.auth-input-group)) .input-field {
            width: calc(100% - 120px); 
        }
        
        /* ì´ë©”ì¼ ê·¸ë£¹ ë° ì¸ì¦ ê·¸ë£¹ì˜ ë„ˆë¹„ (Flex itemìœ¼ë¡œ ë‚¨ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ flex-grow: 1 ì ìš©) */
        .email-input-group, .auth-input-group, .code-input-group {
            display: flex;
            align-items: center;
            flex-grow: 1;
            margin-right: 10px;
        }

        .input-field {
            flex-grow: 1; 
            height: 40px;
            padding: 0 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: #fff;
            box-sizing: border-box; 
            display: flex;
        }

        /* ======== ë²„íŠ¼ ìŠ¤íƒ€ì¼ ======== */

        /* ì¸ì¦ë²ˆí˜¸ ë³´ë‚´ê¸° ë²„íŠ¼ê³¼ í™•ì¸ ë²„íŠ¼ì˜ ë„ˆë¹„ë¥¼ ê³ ì •í•˜ê³ , íŒ¨ë”©ì„ ì¡°ì • */
        .send-auth-button, .check-auth-button, .verify-button {
            width: 100px;
            height: 40px; 
            background-color: #28a745;
            color: white;
            padding: 0;
            font-size: 14px; 
            cursor: pointer;
            flex-shrink: 0; 
            text-shadow: 2px 2px 0 #218838;
            box-shadow: 
                -4px -4px 0 #7dd891 inset, 
                 4px  4px 0 #218838 inset;
            font-family: 'PixelFont', monospace;
            display: flex; 
            justify-content: center;
            align-items: center;
        }


        .send-auth-button:hover,
        .check-auth-button:hover,
        .verify-button:hover {
            background-color: #218838;
        }

        /* NEXT ë²„íŠ¼ */
        .next-button {
            width: 150px; 
            height: 50px; 
            margin: 40px 0 15px;
            background-color: #d89617;
            color: white;
            font-size: 24px; 
            border: 4px solid #8b4513;
            cursor: pointer;
            text-shadow: 2px 2px 0 #8b4513;
            box-shadow: 
                -4px -4px 0 #ffe082 inset, 
                 4px  4px 0 #8b4513 inset;
            line-height: 42px; 
            padding: 0;
            box-sizing: border-box;
            font-family: 'PixelFont', monospace; 
        }

        .next-button:hover {
            background-color: #e0ac42;
        }
        
        /* ì„œë²„ ì‘ë‹µ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        #responseMessage {
            visibility: hidden; 
            width: 80%;
            max-width: 500px;
            min-height: 16px;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            text-align: center;
            font-family: 'PixelFont', monospace;
            color: white;
            font-size: 16px;
        }

        /* ìƒíƒœë³„ ë°°ê²½ìƒ‰ í´ë˜ìŠ¤ */
        .bg-info { background-color: #17a2b8; }
        .bg-pending { background-color: #ffc107; color: black; }
        .bg-success { background-color: #28a745; }
        .bg-error { background-color: #dc3545; }
    </style>


</head>

<body>

    <div class="container">
        <div class="register-window">
            <div class="title-bar">íšŒì›ê°€ì…</div>

            <div class="content-area">
                <div class="input-field-container">
				    <label class="input-label" for="name">ì´ë¦„</label>
				    <input class="input-field" type="text" id="name" name="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
				</div>
				
				<div class="input-field-container">
				    <label class="input-label" for="birthdate">ìƒë…„ì›”ì¼</label>
				    <input class="input-field" type="date" id="birthdate" name="birthdate" required>
				</div>
				
                <form id="sendCodeForm" action="sendCode" method="POST">
                    <label class="input-label" for="email">ì´ë©”ì¼</label>
                    <div class="email-input-group">
                        <input class="input-field" type="email" id="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    <button type="submit" class="send-auth-button">ì¸ì¦ë²ˆí˜¸ ì „ì†¡</button>
                </form>
				
				<form id="verifyCodeForm" action="verifyCode" method="POST">
                    <label class="input-label" for="authCode">ì¸ì¦ë²ˆí˜¸</label>
                    <div class="code-input-group">
                        <input class="input-field" type="text" id="authCode" name="authCode" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬" required maxlength="6">
                    </div>
                    <button type="submit" class="check-auth-button verify-button" id="verifyBtn">ì¸ì¦í™•ì¸</button>
                </form>
                
                <div id="responseMessage"></div>

                <button class="next-button" id="nextButton">NEXT</button>
            </div>
        </div>
    </div>
    
    <script>
    let isAuthOK = false;

    document.addEventListener('DOMContentLoaded', function() {
        const nextButton = document.getElementById('nextButton');
        const responseDiv = document.getElementById('responseMessage');

        function displayResponse(div, text, type) {
            div.textContent = text;
            div.style.visibility = 'visible'; 

            div.classList.remove('bg-info', 'bg-pending', 'bg-success', 'bg-error'); 
            
            if (type === 'success') {
                div.classList.add('bg-success');
            } else if (type === 'error') {
                div.classList.add('bg-error');
            } else if (type === 'pending') {
                div.classList.add('bg-pending');
            } else if (type === 'hide') {
                div.style.visibility = 'hidden'; 
                div.textContent = '';
                return;
            } else {
                div.classList.add('bg-info');
            }
        }

        // â­ï¸ 1. ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ì „ì†¡ í¼ ì²˜ë¦¬ (ì¤‘ë³µ í™•ì¸ ë¡œì§ ì¶”ê°€) â­ï¸
        document.getElementById('sendCodeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = e.target;
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();

            if (!email) {
                displayResponse(responseDiv, "ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error'); 
                return;
            }

            isAuthOK = false; 
            displayResponse(responseDiv, 'ì´ë©”ì¼ ì¤‘ë³µì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...', 'pending');
            
            // âš ï¸ Context Path ë° ì„œë¸”ë¦¿ ê²½ë¡œ í™•ì¸ í•„ìˆ˜ âš ï¸
            const checkDuplicatePath = "/team_project/checkDuplicate"; 

            // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ Fetch ìš”ì²­
            fetch(checkDuplicatePath, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `type=email&value=${encodeURIComponent(email)}` 
            })
            .then(response => response.text())
            .then(text => {
                if (text === "duplicate") {
                    displayResponse(responseDiv, "âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤. ì¸ì¦ë²ˆí˜¸ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
                } else if (text === "available") {
                    // ì¤‘ë³µì´ ì•„ë‹ ê²½ìš°ì—ë§Œ ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ë¡œì§ ì‹¤í–‰
                    sendAuthCode(form, email);
                } else {
                    displayResponse(responseDiv, `ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ: ${text}`, 'error');
                }
            })
            .catch(error => {
                console.error('Email Duplicate Check error:', error);
                displayResponse(responseDiv, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì¤‘ë³µ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        });

        // â­ï¸ ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì‹¤ì œ ë¡œì§ í•¨ìˆ˜ â­ï¸
        function sendAuthCode(form, email) {
            const formData = new FormData(form);
            displayResponse(responseDiv, "ì¸ì¦ë²ˆí˜¸ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...", 'pending');

            fetch(form.action, {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.text())
            .then(text => {
                if (text.includes("ì„±ê³µ") || text.includes("ì „ì†¡ ì™„ë£Œ")) {
                    displayResponse(responseDiv, "ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!", 'success');
                } else {
                    displayResponse(responseDiv, "ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨.", 'error');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                displayResponse(responseDiv, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            });
        }
        
        // 2. ì¸ì¦ë²ˆí˜¸ í™•ì¸ í¼ ì²˜ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼)
        document.getElementById('verifyCodeForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            
            const email = document.getElementById('email').value;
            formData.append('email', email); 
            
            displayResponse(responseDiv, 'ì¸ì¦ë²ˆí˜¸ë¥¼ í™•ì¸ ì¤‘...', 'info');

            fetch(form.action, {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.text())
            .then(text => {
                if (text.includes("ì„±ê³µ") || text.includes("ì¸ì¦ ì„±ê³µ")) {
                    displayResponse(responseDiv, "ğŸ‰ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.", 'success');
                    isAuthOK = true;
                } else {
                    displayResponse(responseDiv, "âš ï¸ ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'error');
                    isAuthOK = false;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                displayResponse(responseDiv, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                isAuthOK = false;
            });
        });
        

        // 3. NEXT ë²„íŠ¼: ì„¸ì…˜ì— ë°ì´í„° ì €ì¥ í›„ ë‹¤ìŒ í˜ì´ì§€ ì´ë™ (ì¤‘ë³µ í™•ì¸ ë¡œì§ ì œê±° -> ì¸ì¦ í™•ì¸ë§Œ ë‚¨ê¹€)
        nextButton.addEventListener('click', function () { 
            const name = document.getElementById('name').value;
            const birthdate = document.getElementById('birthdate').value;
            const email = document.getElementById('email').value;

            if (!name || !birthdate || !email) {
                displayResponse(responseDiv, "ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error'); 
                return;
            }

            if (!isAuthOK) {
                // ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
                displayResponse(responseDiv, "âš ï¸ ì´ë©”ì¼ ì¸ì¦ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.", 'error');
                return;
            }
            
            saveStep1Data(name, birthdate, email); 
        });

        // ë°ì´í„° ì €ì¥ ë° ë‹¤ìŒ í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
        function saveStep1Data(name, birthdate, email) {
            
            const serverPath = "/team_project/saveStep1"; 
            displayResponse(responseDiv, "ì •ë³´ë¥¼ ì„¸ì…˜ì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...", 'pending');

            fetch(serverPath, { 
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body:
                    "name=" + encodeURIComponent(name) + 
                    "&birthdate=" + encodeURIComponent(birthdate) +
                    "&email=" + encodeURIComponent(email)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(result => {
                        return Promise.reject({ status: response.status, result: result });
                    });
                }
                return response.text();
            })
            .then(result => {
                if (result.startsWith("success")) {
                    displayResponse(responseDiv, "ì •ë³´ ì €ì¥ ì„±ê³µ! ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.", 'success');
                    
                    setTimeout(() => {
                        window.location.href = "resister_2.html"; 
                    }, 1000);
                    
                } else {
                    displayResponse(responseDiv, `ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨. ì˜ˆìƒì¹˜ ëª»í•œ ì„œë²„ ì‘ë‹µ: ${result}`, 'error');
                }
            })
            .catch(error => {
                if (error.status) {
                    const statusText = error.status === 400 ? 'í•„ìˆ˜ ë°ì´í„° ëˆ„ë½ ì˜¤ë¥˜' : 'ì„œë²„ ì¸¡ ì˜¤ë¥˜';
                    displayResponse(
                        responseDiv, 
                        `ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨! ìƒíƒœì½”ë“œ: ${error.status} (${statusText}).`, 
                        'error'
                    );
                } else {
                    displayResponse(responseDiv, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
        }
    });
    </script>
</body>
</html>