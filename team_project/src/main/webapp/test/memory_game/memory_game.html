<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë“œ ì§ ë§ì¶”ê¸° ê²Œì„</title>
    <style>
        @font-face {
            font-family: 'PixelFont'; 
            src: url('../DungGeunMo.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            /* ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì • */
            background-image: url('memory_img/memorygameë°°ê²½.png'); 
            background-size: cover;
            background-position: center;
            /* ğŸš© ìˆ˜ì •: ëª¨ë“  ê¸€ì”¨ì— PixelFont ì ìš© */
            font-family: 'PixelFont', Arial, sans-serif; 
            overflow: hidden;
            background-repeat: no-repeat;
            background-size: 60% auto;
            background-color: #87CEEB;
        }

        .game-container {
            background-color: rgba(255, 255, 255, 0.5);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
        }

        .info-board {
            font-size: 35px;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .memory-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            grid-gap: 15px;
            width: 550px;
            height: 670px;
            perspective: 1000px; 
        }
        
        .memory-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform: scale(1);
            transform-style: preserve-3d;
            transition: transform 0.5s;
            cursor: pointer;
        }

        .memory-card.flip {
            transform: rotateY(180deg);
        }

        .memory-card.match {
            transform: scale(0.9);
            box-shadow: 0 0 10px #4caf50;
            opacity: 0.7;
            cursor: default;
        }
        
        .memory-card.disable-click {
            pointer-events: none;
        }
        
        .front-face,
        .back-face {
            width: 100%;
            height: 100%;
            position: absolute;
            border-radius: 5px;
            background-size: cover;
            backface-visibility: hidden;
        }

        .back-face {
            background-image: url('memory_img/memorygameì¹´ë“œ ë’·ë©´.png');
            background-color: #7986cb;
            border: 3px solid #3f51b5;
        }

        .front-face {
            transform: rotateY(180deg);
            background-color: #f1f1f1;
            border: 3px solid #4CAF50;
        }

		.game-over-overlay {
		    position: fixed;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%); 
		    
		    width: 80%; 
		    height: 80%;
		    
		    background-image: url('memory_img/ê²Œì„ì˜¤ë²„_ë°°ê²½X.png');
		    background-size: cover;
		    background-position: center;
		    display: flex;
		    flex-direction: column;
		    justify-content: center;
		    align-items: center;
		    cursor: pointer;
		    visibility: hidden;
		    opacity: 0;
		    transition: opacity 0.5s ease;
		    z-index: 100;
		    color: white;
		    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-family: 'PixelFont', Arial, sans-serif;
		}
        .game-over-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .game-over-message {
            font-size: 2em;
            margin-bottom: 20px;
            font-weight: normal;
        }
        .game-over-sub-message {
            font-size: 1.5em;
            margin-top: 10px;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="game-container">
        
        <div class="info-board">
            ë’¤ì§‘ ì€ íšŸìˆ˜: <span id="moves">0</span>íšŒ
        </div>
        <div class="memory-board" id="memory-board">
            </div>
    </div>

    <div class="game-over-overlay" id="game-over-overlay">
        <div class="game-over-message" id="final-score-message"></div>
        <div class="game-over-sub-message">ì•„ë¬´ ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ ì ìˆ˜ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const memoryBoard = document.getElementById('memory-board');
        const movesDisplay = document.getElementById('moves');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const finalScoreMessage = document.getElementById('final-score-message');
        
        // ğŸš© 13ê°€ì§€ ì¹´ë“œ ì•ë©´ ì´ë¯¸ì§€ ëª©ë¡ (13ê°œ x 2 = 26ì¥)
        const cardImages = [
            'ìŠ¤í˜ì´ë“œ2.png', 'ìŠ¤í˜ì´ë“œ3.png', 'ìŠ¤í˜ì´ë“œ4.png', 'ìŠ¤í˜ì´ë“œ5.png', 
            'ìŠ¤í˜ì´ë“œ9.png', 'ìŠ¤í˜ì´ë“œ8.png', 'ìŠ¤í˜ì´ë“œ7.png', 'ìŠ¤í˜ì´ë“œ6.png',
            'ìŠ¤í˜ì´ë“œ10.png','ìŠ¤í˜ì´ë“œa.png','ìŠ¤í˜ì´ë“œJ.png','ìŠ¤í˜ì´ë“œQ.png',
            'ìŠ¤í˜ì´ë“œK.png'
        ];

        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let moves = 0;

        function createCards() {
            const cardsArray = [...cardImages, ...cardImages];
            
            // Fisher-Yates ì…”í”Œ ì•Œê³ ë¦¬ì¦˜
            for (let i = cardsArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardsArray[i], cardsArray[j]] = [cardsArray[j], cardsArray[i]]; // ì…”í”Œ ì•Œê³ ë¦¬ì¦˜ ì ìš©
            }
            
            return cardsArray; // ì…”í”Œëœ ì¹´ë“œ ë°°ì—´ ë°˜í™˜
        }

        function generateBoard() {
            memoryBoard.innerHTML = ''; // ê¸°ì¡´ ë³´ë“œ ë‚´ìš© ì´ˆê¸°í™”
            const shuffledCards = createCards(); // ì…”í”Œëœ ì¹´ë“œ ë°°ì—´ ë°›ì•„ì˜¤ê¸°

            shuffledCards.forEach(imageName => {
                const card = document.createElement('div');
                card.classList.add('memory-card');
                card.setAttribute('data-image', imageName);

                const frontFace = document.createElement('div');
                frontFace.classList.add('front-face'); 
                frontFace.style.backgroundImage = `url('memory_card_img/${imageName}')`; 
                
                const backFace = document.createElement('div');
                backFace.classList.add('back-face');
                
                card.appendChild(frontFace);
                card.appendChild(backFace);
                
                card.addEventListener('click', flipCard); 

                memoryBoard.appendChild(card);
            });
        }

        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;

            this.classList.add('flip');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }
            
            secondCard = this;
            moves++;
            movesDisplay.textContent = moves;

            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.getAttribute('data-image') === secondCard.getAttribute('data-image');
            
            if (isMatch) {
                disableCards();
            } else {
                unflipCards();
            }
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            
            firstCard.classList.add('match');
            secondCard.classList.add('match');

            resetBoard();
            checkWin();
        }

        function unflipCards() {
            lockBoard = true;

            setTimeout(() => {
                firstCard.classList.remove('flip');
                secondCard.classList.remove('flip');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }
        
        function checkWin() {
            // .match í´ë˜ìŠ¤ê°€ ì—†ëŠ” ì¹´ë“œ(ì•„ì§ ì§ì„ ëª» ë§ì¶˜ ì¹´ë“œ)ì˜ ê°œìˆ˜ê°€ 0ì´ë©´ ìŠ¹ë¦¬
            const remainingCards = document.querySelectorAll('.memory-card:not(.match)').length;
            if (remainingCards === 0) {
                showGameOverScreen(`ì¶•í•˜í•©ë‹ˆë‹¤! ${moves}ë²ˆ ë§Œì— ëª¨ë“  ì§ì„ ë§ì·„ì–´ìš”!`);
            }
        }
        
        // 9. ê²Œì„ ì˜¤ë²„ í™”ë©´ í‘œì‹œ í•¨ìˆ˜ (ìŠ¤ì½”ì–´ ì „ì†¡ ë° ë¦¬ë‹¤ì´ë ‰ì…˜ ìˆ˜ì •)
        function showGameOverScreen(message) {
            const finalMoves = moves; 
            finalScoreMessage.textContent = message;
            
            gameOverOverlay.classList.add('show');
            
            // â­ï¸ 1. ìŠ¤ì½”ì–´(moves)ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤. â­ï¸
            sendScoreToServer(finalMoves);
            
            // â­ï¸ 2. í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í´ë¦­ ì‹œ ì ìˆ˜ë¥¼ URLì— ë‹´ì•„ ì´ë™) â­ï¸
            gameOverOverlay.addEventListener('click', function nextPageHandler() {
                
                // ğŸš© [í•µì‹¬ ìˆ˜ì •] memory_gameover.htmlë¡œ ì ìˆ˜ë¥¼ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
                console.log(`â¡ï¸ memory_gameover.html?score=${finalMoves} ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                window.location.href = `memory_gameover.html?score=${finalMoves}`; 

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                gameOverOverlay.removeEventListener('click', nextPageHandler); 
            });
            
            memoryBoard.style.pointerEvents = 'none';
        }
        
        // â­ï¸ [ì‹ ê·œ í•¨ìˆ˜] ìŠ¤ì½”ì–´ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ëŠ” ë¡œì§ â­ï¸
        function sendScoreToServer(scoreValue) {
            const scoreSaveApiUrl = '/team_project/api/saveScore'; 
            
            fetch(scoreSaveApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    score: scoreValue 
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { 
                        console.error('ìŠ¤ì½”ì–´ ì €ì¥ ì‹¤íŒ¨:', err.message);
                        throw new Error('ìŠ¤ì½”ì–´ ì €ì¥ ì‹¤íŒ¨: ' + (err.message || response.statusText));
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('âœ… ì„œë²„ ì‘ë‹µ (ìŠ¤ì½”ì–´ ì €ì¥):', data);
            })
            .catch(error => {
                console.error('âŒ ìŠ¤ì½”ì–´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            });
        }

        function startGame() {
            moves = 0;
            movesDisplay.textContent = moves;
            resetBoard();
            generateBoard();
            
            memoryBoard.style.pointerEvents = 'auto'; 
        }

        startGame();
    });
</script>
</body>
</html>